#!/usr/bin/perl -w

#  COPYRIGHT NOTICE
#  
#  Silico - A Perl Molecular Toolkit
#  Copyright (C) 2008-25 David K. Chalmers and Benjamin P. Roberts,
#  Department of Medicinal Chemistry, Monash University
#  
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#  
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#  
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.

#<
#! dist_filter
#? Filter docking output based on protein-ligand contact with a specified proten residue, (residue atom, ligand atom element)
#. Use options -i and -l <ligand_name> for output containing both ligand and protein
#  in the same structure (e.g. Glide induced fit output)
#F
#; -asp_<specifier> Atom specifier for protein atom(s)s
#; -asl_<specifier> Atom specifire for ligand atom(s)
#; -p_<protfile> Protein file name 
#; -i Input structure contains both protein and ligand (e.g. From Glide IFD docking)
#; -max_<dist> Filter out ligands with dist greater than this value.
#; -min_<dist> Filter out ligands with dist less than this value.
#; -s_<string> Skip ligands with names starting with 'string'
#
#INCLUDE aslflags2.txt
#
#SF
#. $Revision: 1.1.2.2 $
#. Created: DKC 2022
#>

use strict;
package Silico;

#########################
# Variable declarations #
#########################


my $prot;
my $res;
my $starttime = (times)[0];


###################
# Start of script #
###################

silico_setup();
print_title("dist_filter", '$Revision: 1.1.2.2 $');

my $asp =       make_flag ('asp', 'protein-specifier',  "Protein atom specifier", 1);
my $asl =       make_flag ('asl', 'ligand-specifier',  	"Ligand atom specifier", 1);
my $protfile = 	make_flag ('p', 'protein',  	"Protein filename", 1);
my $ifd = 	make_flag ('i', 'ifd-input',	"Input structure contains both protein and ligand");
my $max = 	make_flag ('max', 'max-dist',   "Filter out ligands with contact distance greater than this value", 1, 4);
my $min = 	make_flag ('min', 'min-dist',   "Filter out ligands with contact distance less than this value", 1);
my $skip = 	make_flag ('s', 'skip',      	"Skip ligands starting with this string", 1);

my $prot_list;

silico_msg('d', "No specifier given for protein atoms\n") if !defined $asp;
silico_msg('d', "No specifier given for ligand atoms\n") if !defined $asl;

if ($ifd) {

 	silico_msg('n', "Each structure contains protein and ligand\n");
	
} elsif (!defined $protfile) {

        silico_msg('n', "No protein file was specified.  Assuming protein is the first structure in each file\n");
	
} else {

        my $mols = read_mol_any($protfile);
        $prot = $mols->[0];
        silico_msg('d', "Could not open protein file $protfile!\n") if !defined $prot;
      	
	$prot_list = get_atoms_using_specifier($prot, $asp);
	printatoms($prot_list, $asp);
}

my @arguments = get_arguments2('>=1');

set_default_oappend('filter');

ARG: foreach my $arg (@arguments) {

	my $average = 0;
	my $avcount = 0;
	my $newmols;
	
	my $molcount = 0;
	
	print "File: $arg\n" if (!get_flag('quiet', 'l'));
	my $mols = read_mol_any ($arg);
	if (!defined $mols) {
		silico_msg('e', "Can not read any molecule data from file $arg!\n",
				"Skipping.\n");
		next;
	}
	
	my $filebase = get_filebase($arg);
	
	open (OUTFILE, ">$filebase\_filter.txt") || silco_msg('d', "Could not open file '$filebase\_ndist.txt'\n");
	
	print OUTFILE "Struct\tLig_at\tProt_at\tDist\tGScore\tSkipped\n";
	
	MOL: foreach my $mol (@$mols) {
	
		if ($ifd) {
		
			$prot = deep_copy($mol) if $ifd;
			$prot_list = get_atoms_using_specifier($prot, $asp);
			printatoms($prot_list, $asp);
		
		} elsif (!$protfile && !defined $prot) {
		
			$prot = $mol;
			$prot_list = get_atoms_using_specifier($prot, $asp);
			printatoms($prot_list, $asp);
		
			# Take first molecule as protein (e.g. from glide output files)
               	 	silico_msg('c', "Assuming that the first input molecule is the protein portion of the complex\n");
			push @$newmols, $mol;
			next MOL;
        	}
		
		++$molcount;
		
		print heading("Filtering\n") if $molcount == 1;
		
		if ($skip && $mol->{NAME} =~ /^$skip/) {
		
			silico_msg('c', "Skipping compound $mol->{NAME}\n");
			next;
		}
		
		#mol_label_functional_group($mol);
		
		my $lig_list = get_atoms_using_specifier($mol, $asl);
		printatoms($lig_list, $asl) if $molcount == 1;

		my $gscore = $mol->{SDF_DATA}{glide_gscore};
		if (defined $gscore) {
			$gscore =  sprintf "%8.6f", $gscore;
		} else {
			$gscore = 'undef';
		} 
		
		$mol->{SDF_DATA}{DIST} = -1;
		
		if (!defined $lig_list->[0]) {
			
			printf OUTFILE "%4d\t%-25s\t%-4s\t%-4s\t%-6s\t%-8s\t*\n", $avcount, $mol->{NAME}, '-', '-', '-', $gscore;
			next MOL;	
		}
		
		my $best1;
		my $best2;
		my $mindist = 999999;
		
		foreach my $atom1 (@$lig_list) {
			foreach my $atom2 (@$prot_list) {
				my $dist = distance ($atom1, $atom2);	
				$mindist = $dist if ($dist < $mindist);
				
				$best1 = $atom1;
				$best2 = $atom2;
			}
		}
		
		$mol->{SDF_DATA}{DIST} = $mindist;
		
		# Filter 
		if (($max && ($mindist > $max))||($min && ($mindist < $min))) {
		
			$mindist = sprintf "%0.2f", $mindist;
			silico_msg('c', "Skipping compound $mol->{NAME}. Closest atom distance $mindist > $max\n") if $max && ($mindist > $max);
			silico_msg('c', "Skipping compound $mol->{NAME}. Closest atom distance $mindist < $min\n") if $min && ($mindist < $min);
			printf OUTFILE "%4d\t%-4s\t%-4s\t%-6.3f\t%-8s\t*\n", $molcount,$best1->{NAME}, $best2->{NAME}, $mindist, $gscore;
			next MOL;
		}
		
		printf OUTFILE "%4d\t%-4s\t%-4s\t%-6.3f\t%-8s\t\n", $molcount, $best1->{NAME}, $best2->{NAME}, $mindist, $gscore;
		
		push @$newmols, $mol;
		
		++$avcount;
		$average += $mindist;
	}
	
	if ($avcount == 0) {
		silico_msg('c', "No structures retained. Skipping\n");
		next ARG;
	} 
	
	$average = $average/$avcount;
	
	silico_msg('c', "\nRetained $avcount structures of ", $molcount, "\n");
		
	printf "\nAverage minimum contact distance for $avcount retained molecules is %5.3f \n\n", ($average);
	printf OUTFILE "\nAverage minimum contact distance for $avcount retained molecules is %5.3f \n\n", ($average);

	write_mol_any($newmols);
}

print_finished_message();
print_timing_message($starttime);

#################
# End of script #
#################






###############
# Subroutines #
###############

sub printatoms {

	my $atoms = $_[0];
	my $as = $_[1];

	print heading("Selected atoms. Specifier: $as\n");
	foreach my $atom (@$atoms) {

		printf "num: %-4s el: %-4s name: %-4s subname: %-4s subid: %-4s\n", $atom->{NUM}, $atom->{ELEMENT}, $atom->{NAME}, $atom->{SUBNAME}, $atom->{SUBID};
	}
	print "\n";
}

sub silico_setup {

        #<
        #? Locate the Silico libraries and read in the parent library, silico.pm
        #; Sets: $Silico::home_dir, $Silico::lib_dir
        #; Requires: nothing
        #; Returns: nothing
        #>

        die "Error: The environment variable SILICO_HOME is not set\n" if !$ENV{SILICO_HOME};

        $Silico::home_dir = $ENV{SILICO_HOME}."/";
        $Silico::lib_dir = $Silico::home_dir."lib/";
        push @INC, substr($Silico::lib_dir, 0, -1);

        require silico;
}
