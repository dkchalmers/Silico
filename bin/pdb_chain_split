#!/usr/bin/perl -w

#  COPYRIGHT NOTICE
#  
#  Silico - A Perl Molecular Toolkit
#  Copyright (C) 2008-25 David K. Chalmers and Benjamin P. Roberts,
#  Department of Medicinal Chemistry, Monash University
#  
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#  
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#  
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.


#<
#! pdb_chain_split
#? Split a pdb file into chains keeping any ligands with that chain
#. Use: pdb_chain_split <file1> <file2> ...
#F

#SF
#. $Revision: 1.1.2.2 $
#. Created: DKC November 1999 and later.
#>

use strict;
package Silico;

#########################
# Variable declarations #
#########################

my $arg;
my @arguments;

my $starttime = (times)[0];

use vars qw($debug_rings);

###################
# Start of script #
###################

silico_setup();
print_title("pdb_chain_split", '$Revision: 1.1.2.2 $');

#$rename = make_flag('r', 'rename', "Rename molecules using SDF data field");


@arguments = get_arguments2('>=1');

foreach $arg (@arguments) {

	my $filebase = get_filebase_short($arg);

	
	my $mols = read_mol_any ($arg);
	my $c;
	next if (!defined $mols);
		
	foreach my $mol (@$mols) {
			
		foreach my $atom (atoms($mol)) {
			
			#atom_printout($atom);
			my $chain = $atom->{CHAIN};
			$chain =~ s/ //g;
			
			$chain ||= '_';
			
			#print "chain $chain\n";
			
			push @{$c->{$chain}}, $atom;
		
		}	
	
	
		foreach my $chain (keys{%$c}) {
	
			my $newmol = molecule_copy_noatoms($mol);
		
			foreach my $atom (@{$c->{$chain}}) {
			
				push @{$newmol->{ATOMS}}, $atom;
				++$newmol->{NUMATOMS};
			}
		
			connect_atoms_by_distance($newmol);
			write_pdb($newmol, $filebase."_$chain.pdb");
		}
	}		
}

print_finished_message();
print_timing_message($starttime);

#################
# End of script #
#################






###############
# Subroutines #
###############

sub silico_setup {

        #<
        #? Locate the Silico libraries and read in the parent library, silico.pm
        #; Sets: $Silico::home_dir, $Silico::lib_dir
        #; Requires: nothing
        #; Returns: nothing
        #>

        die "Error: The environment variable SILICO_HOME is not set\n" if !$ENV{SILICO_HOME};

        $Silico::home_dir = $ENV{SILICO_HOME}."/";
        $Silico::lib_dir = $Silico::home_dir."lib/";
        push @INC, substr($Silico::lib_dir, 0, -1);

        require silico;
}
